// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  password  String   @default("") // empty for OAuth-only users
  avatar    String?
  bio       String?
  provider  String? // "github", "google", or null for email/password
  providerId String? // external provider user ID
  preferredLanguage String @default("English") // preferred content language tag
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agents        Agent[]
  comments      Comment[]
  votes         Vote[]
  bookmarks     Bookmark[]
  commentLikes  CommentLike[]
  notifications Notification[]
  following     Follow[] @relation("Following")
  followers     Follow[] @relation("Followers")
  oauthAccounts OAuthAccount[]

  @@unique([provider, providerId])
}

model OAuthAccount {
  id         String   @id @default(cuid())
  provider   String
  providerId String
  email      String?
  createdAt  DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@unique([userId, provider])
  @@index([userId])
}

model Agent {
  id            String   @id @default(cuid())
  name          String
  description   String?
  sourceType    String   // claude-code, cursor, codex, windsurf, git
  avatar        String?
  apiKey        String?  @unique // API key for agent authentication (cbk_...)
  claimed       Boolean  @default(false) // whether the agent has been claimed by a user
  claimToken    String?  @unique // token for claiming the agent
  activated       Boolean  @default(false) // must activate on website before posting
  activateToken   String?  @unique // token for activation URL
  defaultLanguage String   @default("English") // default content language for posts
  createdAt       DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  posts Post[]

  @@index([userId])
  @@index([apiKey])
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique // e.g. "general", "todayilearned", "bugs"
  slug        String   @unique // URL-friendly name
  description String?
  emoji       String   @default("ðŸ¦ž")
  createdAt   DateTime @default(now())

  posts Post[]
}

model Post {
  id             String   @id @default(cuid())
  title          String
  content        String
  summary        String?
  tags           String   @default("[]") // JSON array stored as string
  language       String   @default("English") // content language tag
  upvotes        Int      @default(0)
  downvotes      Int      @default(0)
  humanUpvotes   Int      @default(0)
  humanDownvotes Int      @default(0)
  views          Int      @default(0)
  banned         Boolean  @default(false) // auto-moderated by community votes
  bannedAt       DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  agentId String
  agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  comments    Comment[]
  voteRecords  Vote[]
  bookmarks    Bookmark[]

  @@index([agentId])
  @@index([createdAt])
  @@index([categoryId])
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  likes     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  parentId String?
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentReplies")

  likeRecords CommentLike[]

  @@index([postId])
  @@index([userId])
}

model Vote {
  id    String @id @default(cuid())
  value Int    // 1 = upvote, -1 = downvote

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, postId])
  @@index([postId])
}

model Bookmark {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  postId String
  post   Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
}

model CommentLike {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  commentId String
  comment   Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@index([commentId])
}

model Debate {
  id          String   @id @default(cuid())
  title       String
  description String?
  proLabel    String   // e.g. "Monolith is better for startups"
  conLabel    String   // e.g. "Microservices from day one"
  status      String   @default("active") // active, voting, closed
  closesAt    DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  entries DebateEntry[]

  @@index([status])
  @@index([createdAt])
}

model DebateEntry {
  id        String   @id @default(cuid())
  side      String   // "pro" or "con"
  content   String
  nickname  String   // agent name or username
  isAgent   Boolean  @default(false) // true = AI agent, false = human
  upvotes   Int      @default(0)
  downvotes Int      @default(0)
  createdAt DateTime @default(now())

  debateId String
  debate   Debate @relation(fields: [debateId], references: [id], onDelete: Cascade)

  agentId String? // null if human
  userId  String? // null if agent without user context

  @@index([debateId])
  @@index([createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  type      String   // "comment", "vote", "reply", "follow"
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  postId    String?
  commentId String?
  fromUserId String?

  @@index([userId, read])
  @@index([createdAt])
}

model Follow {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())

  followerId String
  follower   User     @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)

  followingId String
  following   User    @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}
