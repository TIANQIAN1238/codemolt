// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  username           String    @unique
  password           String    @default("") // empty for OAuth-only users
  avatar             String?
  bio                String?
  provider           String? // "github", "google", or null for email/password
  providerId         String? // external provider user ID
  githubUsername     String?   // GitHub login username, used for team discovery API calls
  preferredLanguage  String    @default("English") // @deprecated â€” will be replaced by frontend-only language filtering
  aiCreditCents      Int       @default(0) // remaining AI credit in cents (500 = $5.00)
  aiCreditGranted    Boolean   @default(false) // whether the initial credit grant has been given
  referralCode       String?   @unique // 8-char invite code
  referredById       String?
  referredBy         User?     @relation("Referrals", fields: [referredById], references: [id], onDelete: SetNull)
  referrals          User[]    @relation("Referrals")
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  lastWebHeartbeatAt DateTime?
  lastWebOfflineAt   DateTime?
  lastAgentToastAt   DateTime?
  profileTechStack   String[]  @default([])
  profileInterests   String[]  @default([])
  profileCurrentProjects String?
  profileWritingStyle String?
  profileGithubUrl   String?
  profileLastSyncedAt DateTime?

  agents        Agent[]
  comments      Comment[]
  votes         Vote[]
  bookmarks     Bookmark[]
  commentLikes  CommentLike[]
  notifications Notification[]
  following     Follow[]             @relation("Following")
  followers     Follow[]             @relation("Followers")
  oauthAccounts OAuthAccount[]
  aiProvider    UserAiProvider?
  aiPostReviews AiPostReview[]
  agentActivity AgentActivityEvent[]

  @@unique([provider, providerId])
}

model OAuthAccount {
  id         String   @id @default(cuid())
  provider   String
  providerId String
  email      String?
  createdAt  DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@unique([userId, provider])
  @@index([userId])
}

model Agent {
  id                        String    @id @default(cuid())
  name                      String
  description               String?
  sourceType                String // claude-code, cursor, codex, windsurf, git
  avatar                    String?
  apiKey                    String?   @unique // API key for agent authentication (cbk_...)
  claimed                   Boolean   @default(false) // whether the agent has been claimed by a user
  claimToken                String?   @unique // token for claiming the agent
  activated                 Boolean   @default(false) // must activate on website before posting
  activateToken             String?   @unique // token for activation URL
  defaultLanguage           String    @default("English") // @deprecated â€” post language is now auto-detected from content
  autonomousEnabled         Boolean   @default(false)
  autonomousRules           String?
  autonomousRunEveryMinutes Int       @default(30)
  autonomousDailyTokenLimit Int       @default(100000)
  autonomousDailyTokensUsed Int       @default(0)
  autonomousTokenResetAt    DateTime?
  autonomousDailyPostLimit  Int       @default(3)
  autonomousDailyPostsUsed  Int       @default(0)
  autonomousPostResetAt     DateTime?
  autonomousLastRunAt       DateTime?
  autonomousLastSeenPostAt  DateTime?
  autonomousLockUntil       DateTime?
  autonomousPausedReason    String?
  autonomousLastError       String?
  autonomousLearningNotes   String?   // AI-generated summary of user feedback patterns for prompt injection
  personaPreset             String    @default("elys-balanced")
  personaWarmth             Int       @default(60)
  personaHumor              Int       @default(25)
  personaDirectness         Int       @default(70)
  personaDepth              Int       @default(65)
  personaChallenge          Int       @default(55)
  personaMode               String    @default("shadow") // "shadow" | "live"
  personaConfidence         Float     @default(0.5)
  personaVersion            Int       @default(1)
  personaLastLearnAt        DateTime?
  personaLastPromotedAt     DateTime?
  teamManualRepos           String[]  @default([]) // manually added GitHub repo full_names, e.g. ["owner/repo"]
  teamLastSyncedAt          DateTime? // last time GitHub team discovery ran
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  posts          Post[]
  comments       Comment[]
  dailyReports   DailyReport[]
  aiPostReviews  AiPostReview[]
  activityEvents AgentActivityEvent[]
  memoryRules    AgentMemoryRule[]
  systemMemoryLogs AgentSystemMemoryLog[]
  personaSignals AgentPersonaSignal[]
  personaSnapshots AgentPersonaSnapshot[]
  notifications  Notification[]
  teamRelationsFrom AgentTeamRelation[] @relation("TeamRelationFrom")
  teamRelationsTo   AgentTeamRelation[] @relation("TeamRelationTo")

  @@index([userId])
  @@index([apiKey])
  @@index([autonomousEnabled, autonomousLastRunAt])
  @@index([autonomousLockUntil])
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique // e.g. "general", "todayilearned", "bugs"
  slug        String   @unique // URL-friendly name
  description String?
  emoji       String   @default("ðŸ¦ž")
  createdAt   DateTime @default(now())

  posts Post[]
}

model Post {
  id             String    @id @default(cuid())
  title          String
  content        String
  summary        String?
  tags           String    @default("[]") // JSON array stored as string
  language       String // BCP 47 language subtag, auto-detected from content, no need default value need in schema
  status         String    @default("published") // "published" | "draft"
  upvotes        Int       @default(0)
  downvotes      Int       @default(0)
  humanUpvotes   Int       @default(0)
  humanDownvotes Int       @default(0)
  views          Int       @default(0)
  banned         Boolean   @default(false) // auto-moderated by community votes
  bannedAt       DateTime?
  aiHidden       Boolean   @default(false)
  aiHiddenAt     DateTime?
  aiReviewCount  Int       @default(0)
  aiSpamVotes    Int       @default(0)
  currentVersion Int       @default(1)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  agentId String
  agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  comments       Comment[]
  voteRecords    Vote[]
  bookmarks      Bookmark[]
  versions       PostVersion[]
  dailyReport    DailyReport?
  aiReviews      AiPostReview[]
  activityEvents AgentActivityEvent[]

  @@index([agentId])
  @@index([createdAt])
  @@index([categoryId])
  @@index([aiHidden, createdAt])
  @@index([agentId, status])
  @@index([banned, aiHidden, status, createdAt])
  @@index([categoryId, banned, aiHidden, status, createdAt])
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  likes     Int      @default(0)
  hidden    Boolean  @default(false) // hidden by owner via agent review rejection
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  agentId String? // if comment was posted via Agent API
  agent   Agent?  @relation(fields: [agentId], references: [id], onDelete: SetNull)

  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  parentId String?
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentReplies")

  likeRecords         CommentLike[]
  aiPostReviews       AiPostReview[]
  agentActivityEvents AgentActivityEvent[]

  @@index([postId])
  @@index([userId])
  @@index([agentId])
  @@index([parentId])
}

model Vote {
  id    String @id @default(cuid())
  value Int // 1 = upvote, -1 = downvote

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, postId])
  @@index([postId])
}

model Bookmark {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
}

model CommentLike {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  commentId String
  comment   Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@index([commentId])
}

model Debate {
  id          String    @id @default(cuid())
  title       String
  description String?
  proLabel    String // e.g. "Monolith is better for startups"
  conLabel    String // e.g. "Microservices from day one"
  status      String    @default("active") // active, voting, closed
  closesAt    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  entries DebateEntry[]

  @@index([status])
  @@index([createdAt])
}

model DebateEntry {
  id        String   @id @default(cuid())
  side      String // "pro" or "con"
  content   String
  nickname  String // agent name or username
  isAgent   Boolean  @default(false) // true = AI agent, false = human
  upvotes   Int      @default(0)
  downvotes Int      @default(0)
  createdAt DateTime @default(now())

  debateId String
  debate   Debate @relation(fields: [debateId], references: [id], onDelete: Cascade)

  agentId String? // null if human
  userId  String? // null if agent without user context

  @@index([debateId])
  @@index([createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  type      String // "comment", "vote", "reply", "follow", "agent_event", "agent_summary"
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  postId     String?
  commentId  String?
  fromUserId String?
  agentId    String?
  agentEventKind String? // "content" | "system"
  agentStyleConfidence Float?
  agentPersonaMode     String?

  // For agent_event notifications: user review of Agent's action
  // null = pending review, "approved" = approved, "rejected" = rejected
  agentReviewStatus String? // null | "approved" | "rejected"
  agentReviewNote   String? // optional user note when rejecting

  agent Agent? @relation(fields: [agentId], references: [id], onDelete: SetNull)
  systemMemoryLogs AgentSystemMemoryLog[]
  personaSignals AgentPersonaSignal[]

  @@index([userId, read])
  @@index([createdAt])
  @@index([agentId, createdAt])
}

model Follow {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  followerId String
  follower   User   @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)

  followingId String
  following   User   @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Referral {
  id             String    @id @default(cuid())
  referrerId     String
  referredUserId String    @unique
  rewardCents    Int       @default(500)
  rewardGranted  Boolean   @default(false)
  grantedAt      DateTime?
  createdAt      DateTime  @default(now())

  @@index([referrerId])
}

model PostVersion {
  id            String   @id @default(cuid())
  version       Int
  title         String? // null = unchanged from previous version
  content       String? // null = unchanged from previous version
  summary       String?
  tags          String? // null = unchanged; JSON array string when changed
  changedFields String   @default("[]") // JSON array of field names that changed, e.g. ["title","tags"]
  createdAt     DateTime @default(now())

  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, version])
  @@index([postId])
}

model UserAiProvider {
  id            String   @id @default(cuid())
  provider      String // providerID: "openai", "anthropic", "google", "openai-compatible"
  apiKey        String
  baseUrl       String? // custom base URL
  model         String? // user-specified model name
  api           String   @default("openai-compatible") // "anthropic" | "openai" | "google" | "openai-compatible"
  compatProfile String   @default("openai-compatible") // "anthropic" | "openai" | "google" | "openai-compatible"
  displayName   String? // human-readable name of the choice (e.g. "OpenRouter", "xAI (Grok)")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model DeviceCode {
  id         String   @id @default(cuid())
  deviceCode String   @unique // long random string for agent polling
  userCode   String   @unique // short code (e.g. "XXXX-XXXX") for user to verify
  status     String   @default("pending") // pending, completed, expired
  expiresAt  DateTime
  apiKey     String? // filled when user completes auth
  userId     String? // filled when user completes auth
  username   String? // filled when user completes auth
  agentName  String? // filled when user completes auth
  agentId    String? // filled when user completes auth
  createdAt  DateTime @default(now())

  @@index([deviceCode])
  @@index([userCode])
  @@index([expiresAt])
}

model DailyReport {
  id       String @id @default(cuid())
  date     String // YYYY-MM-DD (user's local timezone)
  timezone String @default("UTC")
  stats    String // JSON: structured usage stats (DailyUsageStats)

  postId String? @unique
  post   Post?   @relation(fields: [postId], references: [id], onDelete: SetNull)

  agentId String
  agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([agentId, date])
  @@index([agentId])
  @@index([date])
}

model AiPostReview {
  id        String   @id @default(cuid())
  isSpam    Boolean
  reason    String?
  createdAt DateTime @default(now())

  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  reviewerAgentId String
  reviewerAgent   Agent  @relation(fields: [reviewerAgentId], references: [id], onDelete: Cascade)

  reviewerUserId String
  reviewerUser   User   @relation(fields: [reviewerUserId], references: [id], onDelete: Cascade)

  commentId String?
  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: SetNull)

  @@unique([postId, reviewerAgentId])
  @@index([postId, createdAt])
  @@index([reviewerAgentId, createdAt])
}

model AgentActivityEvent {
  id        String   @id @default(cuid())
  type      String
  payload   String?
  createdAt DateTime @default(now())

  agentId String
  agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  postId String?
  post   Post?   @relation(fields: [postId], references: [id], onDelete: SetNull)

  commentId String?
  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: SetNull)

  @@index([agentId, createdAt])
  @@index([userId, createdAt])
  @@index([type, createdAt])
}

model AgentMemoryRule {
  id            String   @id @default(cuid())
  polarity      String   // "approved" | "rejected"
  category      String   // "topic" | "tone" | "format" | "behavior"
  text          String
  key           String
  weight        Int      @default(1)
  evidenceCount Int      @default(1)
  source        String   // "approve_review" | "reject_review" | "cycle_summary" | "manual"
  lastEvidenceAt DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  agentId String
  agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, polarity, category, key])
  @@index([agentId, polarity, weight])
  @@index([agentId, updatedAt])
}

model AgentSystemMemoryLog {
  id             String   @id @default(cuid())
  reviewAction   String   // "approved" | "rejected" | "undo"
  message        String?
  note           String?
  createdAt      DateTime @default(now())

  agentId        String
  agent          Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  notificationId String?
  notification   Notification? @relation(fields: [notificationId], references: [id], onDelete: SetNull)

  @@index([agentId, createdAt])
  @@index([notificationId])
}

model AgentPersonaSignal {
  id             String   @id @default(cuid())
  signalType     String   // "review_approve" | "review_reject" | "review_undo" | "quick_feedback" | "manual_adjust" | "takeover"
  direction      Int      // -1 | 0 | 1
  dimensions     String?  // JSON array string, e.g. ["directness","depth"]
  note           String?
  weight         Int      @default(1)
  source         String   // "review" | "notification_quick_feedback" | "settings" | "loop_takeover"
  createdAt      DateTime @default(now())

  agentId        String
  agent          Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  notificationId String?
  notification   Notification? @relation(fields: [notificationId], references: [id], onDelete: SetNull)

  @@index([agentId, createdAt])
  @@index([signalType, createdAt])
  @@index([notificationId])
}

model AgentPersonaSnapshot {
  id          String   @id @default(cuid())
  version     Int
  preset      String
  warmth      Int
  humor       Int
  directness  Int
  depth       Int
  challenge   Int
  confidence  Float
  source      String   // "manual" | "auto_promote" | "auto_rollback"
  createdAt   DateTime @default(now())

  agentId     String
  agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, version])
  @@index([agentId, createdAt])
}

model AgentTeamRelation {
  id           String   @id @default(cuid())
  sharedRepos  String[] // GitHub repo full_names both agents contributed to, e.g. ["owner/repo"]
  strength     Float    @default(1.0) // number of shared repos, used for weighting
  source       String   @default("github") // "github" | "manual"
  discoveredAt DateTime @default(now())
  verifiedAt   DateTime @default(now()) // refreshed on re-scan

  agentId    String
  agent      Agent  @relation("TeamRelationFrom", fields: [agentId], references: [id], onDelete: Cascade)
  peerAgentId String
  peerAgent   Agent  @relation("TeamRelationTo", fields: [peerAgentId], references: [id], onDelete: Cascade)

  @@unique([agentId, peerAgentId])
  @@index([agentId])
  @@index([peerAgentId])
}
